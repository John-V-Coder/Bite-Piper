{% load humanize funding_extras %}

<!-- Agent Analysis Results Partial -->
<div class="mt-8 fade-in">
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-t-lg p-6">
        <h2 class="text-3xl font-bold flex items-center">
            <span class="mr-3"></span>
            AI Agent Analysis
        </h2>
        <p class="text-purple-100 mt-2">
            Comprehensive ethical, fairness, and transparency analysis powered by ASI.
        </p>
    </div>

    <div class="bg-white rounded-b-lg shadow-lg p-6">
        {% if agent_results %}
            <!-- Analysis Graph -->
            <div class="mb-8 border-2 border-purple-200 rounded-lg p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Analysis Graph</h3>
                <div id="analysis-graph" class="w-full h-[500px] border rounded-lg"></div>
            </div>

            <!-- Agent Analysis by Region -->
            <div class="space-y-6">
                {% for region_name, analysis in agent_results.items %}
                    <div class="border-2 border-purple-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                        <!-- Region Header -->
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold text-gray-800">{{ region_name }}</h3>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Allocated</div>
                                <div class="text-2xl font-bold text-purple-600">
                                    ${{ allocations|get_item:region_name|get_item:'amount'|floatformat:0|intcomma }}
                                </div>
                            </div>
                        </div>

                        {% if analysis.error %}
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <p class="text-red-700">‚ùå {{ analysis.error }}</p>
                            </div>
                        {% else %}
                            <!-- Analysis Modules -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {% for module, data in analysis.items %}
                                    {% if module != 'recommendations' and module != 'error' %}
                                    <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-400">
                                        <h4 class="font-semibold text-gray-900 mb-2 capitalize">{{ module|underscore_to_space }}</h4>
                                        <div class="text-sm text-gray-700">
                                            {% for key, value in data.items %}
                                                <p><strong>{{ key|title }}:</strong> {{ value }}</p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <!-- Recommendations -->
                            {% if analysis.recommendations %}
                            <div class="mt-4 bg-indigo-50 rounded-lg p-4">
                                <h4 class="font-semibold text-indigo-900 mb-2 flex items-center">
                                    <span class="mr-2"></span>
                                    Agent Recommendations
                                </h4>
                                <ul class="text-sm text-indigo-800 list-disc list-inside space-y-1">
                                    {% for rec in analysis.recommendations %}
                                        <li>{{ rec }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8 text-gray-500">
                <p class="text-lg">No agent analysis available.</p>
                <p class="text-sm mt-2">Click "Analyze with AI Agent" to get comprehensive insights.</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const agentData = {{ agent_results_json|safe }};
        if (!agentData) return;

        const nodes = [];
        const edges = [];
        let nodeId = 1;

        // Central node
        const centralNodeId = nodeId++;
        nodes.push({ id: centralNodeId, label: 'Funding Decision', group: 'decision', shape: 'star', color: '#ffc107' });

        for (const [regionName, analysis] of Object.entries(agentData)) {
            const regionNodeId = nodeId++;
            nodes.push({ id: regionNodeId, label: regionName, group: 'region' });
            edges.push({ from: centralNodeId, to: regionNodeId });

            if (analysis.error) continue;

            for (const [moduleName, moduleData] of Object.entries(analysis)) {
                if (moduleName === 'recommendations') continue;

                const moduleNodeId = nodeId++;
                nodes.push({ id: moduleNodeId, label: moduleName.replace('_', ' ').toTitleCase(), group: 'module' });
                edges.push({ from: regionNodeId, to: moduleNodeId });
            }

            if (analysis.recommendations) {
                for (const rec of analysis.recommendations) {
                    const recNodeId = nodeId++;
                    nodes.push({ id: recNodeId, label: rec, group: 'recommendation', shape: 'box' });
                    edges.push({ from: regionNodeId, to: recNodeId });
                }
            }
        }

        const container = document.getElementById('analysis-graph');
        const data = { nodes: nodes, edges: edges };
        const options = {
            nodes: {
                shape: 'dot',
                size: 16,
                font: { size: 14, color: '#333' },
                borderWidth: 2,
            },
            edges: {
                width: 2,
                arrows: 'to',
            },
            layout: {
                hierarchical: {
                    enabled: true,
                    levelSeparation: 200,
                    nodeSpacing: 150,
                    treeSpacing: 250,
                    direction: 'UD',
                    sortMethod: 'directed',
                },
            },
            physics: {
                hierarchicalRepulsion: {
                    nodeDistance: 150,
                },
            },
            groups: {
                decision: { color: { background: '#ffc107', border: '#ff9800' }, shape: 'star' },
                region: { color: { background: '#8bc34a', border: '#689f38' } },
                module: { color: { background: '#2196f3', border: '#1976d2' } },
                recommendation: { color: { background: '#9c27b0', border: '#7b1fa2' }, shape: 'box' },
            },
        };

        new vis.Network(container, data, options);
    });

    String.prototype.toTitleCase = function() {
        return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
    }
</script>